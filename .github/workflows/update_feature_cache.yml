name: Update Feature Cache

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start Date (YYYYMMDD)'
        required: false
        default: '20251201'
      end_date:
        description: 'End Date (YYYYMMDD) - Defaults to Today'
        required: false
        default: ''
  schedule:
    # Weekdays 17:00 KST == 08:00 UTC
    - cron: '0 8 * * 1-5'

permissions:
  contents: write

jobs:
  generate-cache:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Export KRX Stock Master (parquet)
      run: |
        python scripts/export_krx_stock_master_parquet.py --input-json data/krx_stock_master.json --output-parquet cache/krx_stock_master.parquet
        
    - name: Generate Feature Cache
      run: |
        # Handle inputs with defaults
        START_DATE="${{ inputs.start_date }}"
        if [ -z "$START_DATE" ]; then
          START_DATE="20251201"
        fi
        
        END_DATE="${{ inputs.end_date }}"
        if [ -z "$END_DATE" ]; then
          END_DATE=$(date +'%Y%m%d')
        fi
        
        echo "Generating cache from $START_DATE to $END_DATE"
        
        python scripts/generate_cache.py \
          --start-date "$START_DATE" \
          --end-date "$END_DATE" \
          --output cache/korea_universe_feature_frame.parquet \
          --meta-output cache/korea_universe_feature_frame.meta.json \
          --industry-output cache/korea_industry_feature_frame.parquet \
          --industry-meta-output cache/korea_industry_feature_frame.meta.json \
          --krx-stock-master-json data/krx_stock_master.json

    - name: Detect Generated Files
      id: files
      run: |
        if [ -f "cache/krx_stock_master.parquet" ]; then
          echo "has_master=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_master=false" >> "$GITHUB_OUTPUT"
        fi
        if [ -f "cache/korea_universe_feature_frame.parquet" ]; then
          echo "has_feature=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_feature=false" >> "$GITHUB_OUTPUT"
        fi
        if [ -f "cache/korea_universe_feature_frame.meta.json" ]; then
          echo "has_meta=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_meta=false" >> "$GITHUB_OUTPUT"
        fi
        if [ -f "cache/korea_industry_feature_frame.parquet" ]; then
          echo "has_industry=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_industry=false" >> "$GITHUB_OUTPUT"
        fi
        if [ -f "cache/korea_industry_feature_frame.meta.json" ]; then
          echo "has_industry_meta=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_industry_meta=false" >> "$GITHUB_OUTPUT"
        fi
        
    - name: Upload Artifact (meta only)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: feature-cache-meta
        path: |
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
        retention-days: 7

    - name: Upload Artifact (full, without industry)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature == 'true' && steps.files.outputs.has_industry != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: feature-cache-parquet
        path: |
          cache/korea_universe_feature_frame.parquet
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
        retention-days: 7

    - name: Upload Artifact (full, with industry)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature == 'true' && steps.files.outputs.has_industry == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: feature-cache-parquet
        path: |
          cache/korea_universe_feature_frame.parquet
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
          cache/korea_industry_feature_frame.parquet
          cache/korea_industry_feature_frame.meta.json
        retention-days: 7

    - name: Generate Tag Name
      id: tag
      run: echo "tag_name=data-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

    - name: Create Release (meta only)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature != 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag_name }}
        name: Feature Cache ${{ steps.tag.outputs.tag_name }} (KST)
        files: |
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release (full, without industry)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature == 'true' && steps.files.outputs.has_industry != 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag_name }}
        name: Feature Cache ${{ steps.tag.outputs.tag_name }} (KST)
        files: |
          cache/korea_universe_feature_frame.parquet
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release (full, with industry)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature == 'true' && steps.files.outputs.has_industry == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag_name }}
        name: Feature Cache ${{ steps.tag.outputs.tag_name }} (KST)
        files: |
          cache/korea_universe_feature_frame.parquet
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
          cache/korea_industry_feature_frame.parquet
          cache/korea_industry_feature_frame.meta.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
