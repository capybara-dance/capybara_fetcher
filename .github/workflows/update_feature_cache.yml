name: Update Feature Cache

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start Date (YYYYMMDD)'
        required: false
        default: '20150101'
      end_date:
        description: 'End Date (YYYYMMDD) - Defaults to Today'
        required: false
        default: ''
      provider:
        description: 'Data Provider'
        required: false
        default: 'composite'
        type: choice
        options:
          - composite
          - pykrx
          - korea_investment
          - fdr
  schedule:
    # Weekdays 17:00 KST == 08:00 UTC
    - cron: '0 0,8 * * 1-5'

permissions:
  contents: write

jobs:
  generate-cache:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build KRX Stock Master (JSON with FDR name updates)
      run: |
        python scripts/build_krx_stock_master.py --kospi-xlsx data/kospi.xlsx --kosdaq-xlsx data/kosdaq.xlsx --output-json data/krx_stock_master.json --include-etf

    - name: Export KRX Stock Master (parquet)
      run: |
        python scripts/export_krx_stock_master_parquet.py --input-json data/krx_stock_master.json --output-parquet cache/krx_stock_master.parquet
        
    - name: Generate Feature Cache
      env:
        HT_KE: ${{ secrets.HT_KE }}
        HT_SE: ${{ secrets.HT_SE }}
      run: |
        # Handle inputs with defaults
        START_DATE="${{ inputs.start_date }}"
        if [ -z "$START_DATE" ]; then
          START_DATE="20150101"
        fi
        
        END_DATE="${{ inputs.end_date }}"
        if [ -z "$END_DATE" ]; then
          END_DATE=$(date +'%Y%m%d')
        fi
        
        PROVIDER="${{ inputs.provider }}"
        if [ -z "$PROVIDER" ]; then
          PROVIDER="composite"
        fi
        
        echo "Generating cache from $START_DATE to $END_DATE using provider: $PROVIDER"
        
        python scripts/generate_cache.py \
          --start-date "$START_DATE" \
          --end-date "$END_DATE" \
          --output cache/korea_universe_feature_frame.parquet \
          --meta-output cache/korea_universe_feature_frame.meta.json \
          --industry-output cache/korea_industry_feature_frame.parquet \
          --industry-meta-output cache/korea_industry_feature_frame.meta.json \
          --industry-benchmark universe \
          --krx-stock-master-json data/krx_stock_master.json \
          --provider "$PROVIDER"
    - name: Detect Generated Files
      id: files
      run: |
        if [ -f "cache/krx_stock_master.parquet" ]; then
          echo "has_master=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_master=false" >> "$GITHUB_OUTPUT"
        fi
        if [ -f "cache/korea_universe_feature_frame.parquet" ]; then
          echo "has_feature=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_feature=false" >> "$GITHUB_OUTPUT"
        fi
        if [ -f "cache/korea_universe_feature_frame.meta.json" ]; then
          echo "has_meta=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_meta=false" >> "$GITHUB_OUTPUT"
        fi
        if [ -f "cache/korea_industry_feature_frame.parquet" ]; then
          echo "has_industry=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_industry=false" >> "$GITHUB_OUTPUT"
        fi
        if [ -f "cache/korea_industry_feature_frame.meta.json" ]; then
          echo "has_industry_meta=true" >> "$GITHUB_OUTPUT"
        else
          echo "has_industry_meta=false" >> "$GITHUB_OUTPUT"
        fi
        
    - name: Upload Artifact (meta only)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: feature-cache-meta
        path: |
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
        retention-days: 7

    - name: Upload Artifact (full, without industry)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature == 'true' && steps.files.outputs.has_industry != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: feature-cache-parquet
        path: |
          cache/korea_universe_feature_frame.parquet
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
        retention-days: 7

    - name: Upload Artifact (full, with industry)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature == 'true' && steps.files.outputs.has_industry == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: feature-cache-parquet
        path: |
          cache/korea_universe_feature_frame.parquet
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
          cache/korea_industry_feature_frame.parquet
          cache/korea_industry_feature_frame.meta.json
        retention-days: 7

    - name: Generate Tag Name
      id: tag
      run: echo "tag_name=data-$(date +'%Y%m%d-%H%M')" >> $GITHUB_OUTPUT

    - name: Create Release (meta only)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature != 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag_name }}
        name: Feature Cache ${{ steps.tag.outputs.tag_name }} (KST)
        files: |
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release (full, without industry)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature == 'true' && steps.files.outputs.has_industry != 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag_name }}
        name: Feature Cache ${{ steps.tag.outputs.tag_name }} (KST)
        files: |
          cache/korea_universe_feature_frame.parquet
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release (full, with industry)
      if: steps.files.outputs.has_meta == 'true' && steps.files.outputs.has_feature == 'true' && steps.files.outputs.has_industry == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag_name }}
        name: Feature Cache ${{ steps.tag.outputs.tag_name }} (KST)
        files: |
          cache/korea_universe_feature_frame.parquet
          cache/korea_universe_feature_frame.meta.json
          cache/krx_stock_master.parquet
          cache/korea_industry_feature_frame.parquet
          cache/korea_industry_feature_frame.meta.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify Telegram
      if: always()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID_TEST: ${{ secrets.TELEGRAM_CHAT_ID_TEST }}
        JOB_STATUS: ${{ job.status }}
        RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        WORKFLOW_NAME: ${{ github.workflow }}
        JOB_NAME: ${{ github.job }}
      run: |
        python - <<'PY'
        import os

        from scripts.telegram import TelegramSender

        status = os.getenv("JOB_STATUS", "unknown")
        run_url = os.getenv("RUN_URL", "")
        workflow = os.getenv("WORKFLOW_NAME", "workflow")
        job = os.getenv("JOB_NAME", "job")
        message = f"[{workflow}] job '{job}' finished with status: {status}\n{run_url}"

        TelegramSender().send_message(message, parse_mode=None)
        PY
